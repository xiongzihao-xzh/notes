和 AOF 相比，RDB 记录的是某一时刻的数据，并不是操作，所以，在做数据恢复时，我们可 以直接把 RDB 文件读入内存，很快地完成恢复
Redis 提供了两个命令来生成 RDB 文件，分别是 save 和 bgsave：
* save：在主线程中执行，会导致阻塞
* bgsave：创建一个子进程，专门用于写入 RDB 文件，避免了主线程的阻塞，这也是 Redis RDB 文件生成的默认配置
# 写时复制
Redis 会借助操作系统提供的 写时复制技术（Copy-On-Write, COW），在执行快照的同时，正常处理写操作
![[写时复制机制保证快照期间数据可修改 20240424221251.png]]
# 快照机制下的数据丢失
如下图所示，我们先在 T0 时刻做了一次快照，然后又在 T0+t 时刻做了一次快照，在这期 间，数据块 5 和 9 被修改了。如果在 t 这段时间内，机器宕机了，那么，只能按照 T0 时刻的 快照进行恢复。此时，数据块 5 和 9 的修改值因为没有快照记录，就无法恢复了
![[快照机制下的数据丢失 20240424221639.png]]
连续的快照会有两方面的开销：
 * 磁盘压力
 * fork 过程本身会阻塞主线程
在 Redis 中 如果有一个 bgsave 在运行，就不会再启动第二个 bgsave 子进程
# 增量快照
所谓增量快照，就是指，做了一次全量快照后，后续的快照只对 修改的数据进行快照记录，这样可以避免每次全量快照的开销。这么做的前提是，我们需要记住哪些数据被修改了，它需要我们使用额外的元数据信息去记录哪些数据被修改了，这会带来额外的 空间开销问题
![[增量快照示意图 20240424222054.png]]
Redis 4.0 中提出了一个混合使用 AOF 日志和内存快照的方法。内存快照以一定的频率执行，在两次快照之间，使用 AOF 日志记录这期间的所有命令操作
![[内存快照和AOF混合使用 20240424222551.png]]

