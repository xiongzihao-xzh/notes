Redis 提供了主从库模式，以保证数据副本的一致，主从库之间采用的是读写分离的方式
读操作：主库、从库都可以接收
写操作：首先到主库执行，然后，主库将写操作同步给从库
![[Redis 主从库和读写分离 20240425232239.png]]
# 同步过程
![[主从库第一次同步的流程 20240425232933.png]]
第一阶段是主从库间建立连接、协商同步的过程，主要是为全量复制做准备。在这一步，从库 和主库建立起连接，并告诉主库即将进行同步，主库确认回复后，主从库间就可以开始同步了
具体来说，从库给主库发送 psync 命令，表示要进行数据同步，主库根据这个命令的参数来 启动复制。psync 命令包含了主库的 runID 和复制进度 offset 两个参数
主库收到 psync 命令后，会用 FULLRESYNC 响应命令带上两个参数：主库 runID 和主库目 前的复制进度 offset，返回给从库。从库收到响应后，会记录下这两个参数
FULLRESYNC 响应表示第一次复制采用的全量复制，也就是说，主库会把当前所有的数据都复制给从库
在第二阶段，主库将所有数据同步给从库。从库收到数据后，在本地完成数据加载。这个过程 依赖于内存快照生成的 RDB 文件
主库不会被阻塞，主库会在内存中用专门的 replication buffer，记录 RDB 文件生成后收到的所有写操作
第三个阶段，主库会把第二阶段执行过程中新收到的写命令，再发送给从库。具体的操作是，当主库完成 RDB 文件发送后，就会把此时 replication buffer 中的修改操作发给从库，从库再重新执行这些操作
# 主库压力
一次全量复制中，对于主库来说，需 要完成两个耗时的操作：生成 RDB 文件和传输 RDB 文件
通过“主 - 从 - 从”模式将主库生成 RDB 和传输 RDB 的压力，以级联的方式分散到从库上
![[级联的“主-从-从”模式 20240425233939.png]]
一旦主从库完成了全量复制，它们之间就会一直维护一个网络连接，主库会通过这个连接将后续陆续收到的命令操作再同步给从库，这个过程也称为基于长连接的命令传播，可以避免频繁建立连接的开销
# 主从间网络
当主从库断连后，主库会把断连期间收到的写操作命令，写入 replication buffer，同时也会 把这些操作命令也写入 repl_backlog_buffer 这个缓冲区
repl_backlog_buffer 是一个环形缓冲区，主库会记录自己写到的位置，从库则会记录自己已 经读到的位置
![[Redis repl_backlog_buffer 的使用 20240425234544.png]]
![[Redis增量复制流程 20240425234651.png]]
如果从库的读取速度比较慢，就有可能导致从库还未读取的操作被主库新写的操作覆盖了，这会导致主从库间的数据不一致
