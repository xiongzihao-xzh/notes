![[主库故障后从库无法服务写操作 20240426220444.png]]
# 哨兵机制的基本流程
哨兵是一个运行在特殊模式下的 Redis 进程，主从库实例运行的同时，它也在运行。哨兵主要负责的就是三个任务：监控、选主（选择主库）和通知
* 监控是指哨兵进程在运行时，周期性地给所有的主从库发送 PING 命令，检测它们是否仍然在线运行。如果从库没有在规定时间内响应哨兵的 PING 命令，哨兵就会把它标 记为“下线状态”；同样，如果主库也没有在规定时间内响应哨兵的 PING 命令，哨兵就会判定主库下线，然后开始自动切换主库的流程
* 选主。主库挂了以后，哨兵就需要从很多个从库里， 按照一定的规则选择一个从库实例，把它作为新的主库。这一步完成后，现在的集群里就有了新主库
* 通知。在执行通知任务时，哨兵会把新主库的连接信息发给 其他从库，让它们执行 replicaof 命令，和新主库建立连接，并进行数据复制。同时，哨兵会把新主库的连接信息通知给客户端，让它们把请求操作发到新主库上
![[哨兵机制的三项任务与目标 20240426220849.png]]
# 主管下线和客观下线
如果哨兵发现主库或从库对 PING 命令的响应超时了，那么，哨兵就会先把它标记为“主观下 线”
在判断主库是否下线时，不能由一个哨兵说了算，只有大多数的哨兵实例，都判断主库已经 “主观下线”了，主库才会被标记为“客观下线”
![[客观下线的判断 20240426221252.png]]
# 选主
![[新主库的选择过程 20240426221648.png]]
选主时，检查从库的当前在线状态，判断之前的网络连接状态。使用配置项 down-after-milliseconds * 10。其中，down-aftermilliseconds 是我们认定主从库断连的最大连接超时时间。如果在 down-after-milliseconds 毫秒内，主从节点都没有通过网络联系上，我们就可以认为主从节点断连了。如果发生断连的次数超过了 10 次，就说明这个从库的网络状况不好，不适合作为新主库
从库优先级、从库复制进度以及从库 ID 号。只要在某一轮中，有从库得分最高，那么 它就是主库了
1. 优先级最高的从库得分高。通过 slave-priority 配置项，给不同的从库设置不同优先级
2. 和旧主库同步程度最接近的从库得分高
3. ID 号小的从库得分高。在优先级和复制进度都相同的情况下，ID 号最小的从库得分最高，会被选为新主库
![[基于复制进度的新主库选主原则 20240426221932.png]]
# 基于 pub/sub 机制的哨兵集群组成
哨兵实例之间可以相互发现，要归功于 Redis 提供的 pub/sub 机制，也就是发布 / 订阅机制
哨兵只要和主库建立起了连接，就可以在主库上发布消息了，比如说发布它自己的连接信息 （IP 和端口）。同时，它也可以从主库上订阅消息，获得其他哨兵发布的连接信息。当多个 哨兵实例都在主库上做了发布和订阅操作后，它们之间就能知道彼此的 IP 地址和端口
![[哨兵集群 20240427224423.png]]
哨兵除了彼此之间建立起连接形成集群外，还需要和从库建立连接。这是因为，在哨兵的监控 任务中，它需要对主从库都进行心跳判断，而且在主从库切换完成后，它还需要通知从库，让它们和新主库进行同步
# 获取从库 IP 地址和端口号
哨兵给主库发送 INFO 命令，主库接受到这个命令后，就会把从库列表返回给哨兵。哨兵就可以根据从库列表中 的连接信息，和每个从库建立连接
![[哨兵和从库建立连接 20240427224959.png]]
# 基于 pub/sub 机制的客户端事件通知
**从本质上说，哨兵就是一个运行在特定模式下的 Redis 实例**，每个哨兵实例也提供 pub/sub 机制
![[事件和相关频道 20240427225450.png]]
任何一个实例只要自身判断主库“主观下线”后，就会给其他实例发送 is-master-down-byaddr 命令。接着，其他实例会根据自己和主库的连接情况，做出 Y 或 N 的响应，Y 相当于赞 成票，N 相当于反对票
![[投票 20240427225812.png]]
一个哨兵获得了仲裁所需的赞成票数后，就可以标记主库为“客观下线”。这个所需的赞成票 数是通过哨兵配置文件中的 quorum 配置项设定的
![[Leader 选举 20240427230041.png]]

